---

- name: Add apt repository postgres
  apt_repository:
    repo: deb http://apt.postgresql.org/pub/repos/apt/ trusty-pgdg main
    state: present


- name: Ensure packages installed
  apt:
    name: "{{ item }}"
    state: present
    allow_unauthenticated: yes
  with_items:
    - postgresql-9.5

- name: Ensure the PostgreSQL service is running
  service: name=postgresql state=started enabled=yes

- name: Install psycopg2
  apt:
            name: python-psycopg2
            state: present


- name: Ensure database is created
  become: true
  become_user: postgres
  postgresql_db: 
             name: "{{ db_name }}"
             encoding: 'UTF-8'
             lc_collate: 'en_US.UTF-8'
             lc_ctype: 'en_US.UTF-8'
             template: 'template0'
             state: present

- name: Ensure user has access to the database
  become: true
  become_user: postgres
  postgresql_user: 
             db: "{{ db_name }}"
             name: "{{ db_user }}"
             password: "{{ db_password }}"
             priv: "ALL"
             state: present
